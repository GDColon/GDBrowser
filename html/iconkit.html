<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135255146-3"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'UA-135255146-3');</script>
    <title>Online Icon Kit</title>
    <link href="../css/generate.css" type="text/css" rel="stylesheet">
    <meta name="viewport" content="width=1024">
    <meta property="og:description" content="Build and save your very own Geometry Dash icons, right from the internet!">
    <meta property="og:title" content="Geometry Dash Online Icon Kit">
    <meta property="og:type" content="website">
    <meta name="og:image" itemprop="image" content="../iconkitbuttons/iconkit.png">
    <meta name="theme-color" content="#CCFF55">
    <link rel="icon" href="../assets/icon.png">
    </link>
</head>
<body class="iconscroll" style="background-image: linear-gradient(rgb(139, 139, 139), rgb(100, 100, 100));">
<div class="center"><br>
    <img id="iconkitlogo" src="../assets/iconkit.png" height=50px; style="margin: 7px 0;"><br><br>
    <img id="loading" src="../assets/loading.png" class="spin" height=95px; style="margin: auto auto 25px auto">
    <img id="result" src="../icon/icon" download="icon.png">
    <hr id="gdfloor">
    <div id="menuButtons" style="height: 65px; margin: 0 0 15 0;">
        <button class="blankButton menuButton" id="downloadIcon" title="Download icon"><a id="downloadLink" download="icon.png" href="../icon/icon"><img src="../iconkitbuttons/download.png" width=50px></a></button>
        <button class="blankButton menuButton" id="generateIcon" title="Generate icon"><img src="../iconkitbuttons/play.png" width=65px></button>
        <button class="blankButton menuButton" id="fetchUser" title="Get account icon"><img src="../iconkitbuttons/player.png" width=50px></button>
        </div>
        <div id="iconTabs"></div><br>
        <div id="iconKitParent" class="iconKit">
            <div id="iconprogressbar">
                <div id="iconloading"></div>
            </div>
        </div><br>
        <div id="colors" class="iconKit">
            <div id="col1"></div>
            <div id="col2"></div>
    </div><br>
    <p style="color: rgb(20, 20, 20); margin-top: 3;">All sprites/assets belong to <a href="http://robtopgames.com">RobTop Games</a>.</p>

    <div style="position:absolute; top: 2%; left: -1.95%; width: 10%; height: 25%; pointer-events: none">
		<img class="gdButton" style="pointer-events: all" id="backButton" src="../assets/back.png" height="30%" onclick="backButton()">
	</div>
    
</div>
</body>
<script type="text/javascript">

document.querySelector('#loading').style.display = 'none';
for (let el of document.querySelectorAll('.hidden')) el.style.display = 'block';

let mobile =  /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)
let forms = ['cube', 'ship', 'ball', 'ufo', 'wave', 'robot', 'spider']
let currentForm = 'cube'

let selectedIcon = 1
let selectedForm = 'cube'
let selectedCol1 = 0
let selectedCol2 = 3
let enableGlow = 0

function capitalize(str) {return str[0].toUpperCase() + str.substr(1)}

if (mobile) {
  document.querySelector('#logo').setAttribute('width', '80%');
}

document.querySelector("#iconTabs").insertAdjacentHTML('beforeEnd', forms.map(form => `<button form="${form}" class="blankButton iconTabButton"><img src="../iconkitbuttons/${form}_off.png" width=50px></button>`).join(''))
document.querySelector("#iconTabs").insertAdjacentHTML('beforeEnd', `<button class="blankButton glowToggle" id="glowbtn"><img id="glow" src="../iconkitbuttons/streak_off.png" width=50px></button>`)

forms.forEach(form => {document.querySelector("#iconKitParent").insertAdjacentHTML('beforeEnd', `<div id="${form}s"></div>`)})

fetch('./api/icons').then(res => {
    return (res.json())})
    .then(iconArray => {

      function filterIcon(name) { return iconArray.filter(x => x.startsWith(name)).sort(function (a,b) {return a.replace(/[^0-9]/g, "") - b.replace(/[^0-9]/g, "");})}

      function appendIcon(form, formName) {

        document.querySelector('#' + formName + 's').insertAdjacentHTML('beforeEnd', '<br>')

        form.forEach(function (i, p) {
        if (p != 0 && p % 12 == 0) document.querySelector('#' + formName + 's').insertAdjacentHTML('beforeEnd', '<br>')
        document.querySelector('#' + formName + 's').insertAdjacentHTML('beforeEnd', `<button num="${p+1}" form="${formName}" class="blankButton iconButton" id="${formName}-${p + 1}"><img src="../gdicon/${i}" width="50px" title="${capitalize(formName)} ${p + 1}"></button>`)})
      }

      let cubes = filterIcon('cube'); 
      cubes.push(cubes.shift());
      appendIcon(cubes, 'cube');

      filterIcon('color').forEach(function (i, p) {
        document.querySelector('#col1').insertAdjacentHTML('beforeEnd', `<button col=${p} class="blankButton color1" title="Color ${p}" id="col1-${p}"><img src="../gdicon/color_${p}.png" width=50px></button>`)
        document.querySelector('#col2').insertAdjacentHTML('beforeEnd', `<button col=${p} class="blankButton color2" title="Color ${p}" id="col2-${p}"><img src="../gdicon/color_${p}.png" width=50px></button>`)
      })

      document.querySelector('#col1').insertAdjacentHTML('beforeEnd', "<span style='min-width: 10px'></span>")
      document.querySelector('#col2').insertAdjacentHTML('beforeEnd', "<span style='min-width: 10px'></span>")
      document.querySelector('.color1[col="0"]').classList.add('iconSelected');
      document.querySelector('.color2[col="3"]').classList.add('iconSelected');

      for (let el of document.querySelectorAll('.iconTabButton')) el.addEventListener('click', function () {

        var form = el.getAttribute('form')
        var forms = '#' + form + 's'

        currentForm = form

        for (let el of document.querySelectorAll('.iconTabButton')) {
          el.firstChild.setAttribute('src', el.firstChild.getAttribute('src').replace('_on', '_off'));
        }
        var img = el.firstChild;
        img.setAttribute('src', img.getAttribute('src').replace('_off', '_on'));

        for (let el of document.querySelector('#iconKitParent').children) {
          if (el.id != 'iconprogressbar') el.style.display = 'none';
        }
        if (!document.querySelector(forms) || document.querySelector(forms).innerHTML == "") appendIcon(filterIcon(form), form)
        document.querySelector(forms).style.display = 'block';
      })

    for (let el of document.querySelectorAll('.color1')) el.addEventListener('click', function () {
      for (let el of document.querySelectorAll(".color1")) el.classList.remove("iconSelected");
      el.classList.add('iconSelected');
      selectedCol1 = el.getAttribute('col');
    })
    for (let el of document.querySelectorAll('.color2')) el.addEventListener('click', function () {
      for (let el of document.querySelectorAll(".color2")) el.classList.remove("iconSelected");
      el.classList.add('iconSelected');
      selectedCol2 = el.getAttribute('col');
    })

    document.querySelector("#generateIcon").addEventListener('click', function () {
      document.querySelector("#loading").style.display = 'block';
      document.querySelector("#result").style.display = 'none';
      document.querySelector("#result").setAttribute('src', `../icon/icon?icon=${selectedIcon}&form=${selectedForm}&col1=${selectedCol1}&col2=${selectedCol2}&glow=${enableGlow}`)
      document.querySelector("#downloadLink").setAttribute('href', `../icon/icon?icon=${selectedIcon}&form=${selectedForm}&col1=${selectedCol1}&col2=${selectedCol2}&glow=${enableGlow}`)
    })

    document.querySelector('#result').addEventListener('load', function() {
      document.querySelector("#loading").style.display = 'none';
      document.querySelector('#result').style.removeProperty('display');
        if (enableGlow == 1) document.querySelector("#gdfloor").style.marginTop = '-3px'
        else document.querySelector("#gdfloor").style.marginTop = '0px';
    })

    document.querySelector("#fetchUser").addEventListener('click', function () {
        
        let user = prompt(`Enter a player's username to get their ${currentForm == "ufo" ? "UFO" : currentForm}!\n(Form will depend on selected tab)\n`)
        if (!user) return;

        let iconURL = `../icon/${user}?form=${currentForm}`
        document.querySelector("#loading").style.display = 'block'
        document.querySelector("#result").style.display = 'hidden';
        document.querySelector("#result").setAttribute('src', iconURL)
        document.querySelector("#downloadLink").setAttribute('href', iconURL)
        document.querySelector('#glow').setAttribute('src', '../iconkitbuttons/streak_off.png')
        enableGlow = 0

        fetch('../api/profile/' + user).then(res => res.json())
        .then(info => {
          document.querySelector(`#${currentForm}-${info.icon}`).click()
          document.querySelector(`#col1-${info.col1}`).click()
          document.querySelector(`#col2-${info.col2}`).click()
            if (info.glow) document.querySelector('#glowbtn').click()
        })
      })
      for (let el of document.querySelectorAll('.glowToggle')) el.addEventListener('click', function () {
        if (enableGlow) {
            document.querySelector("#glow").setAttribute('src', document.querySelector("#glow").getAttribute('src').replace('_on', '_off'))
            enableGlow = 0;
        }

        else {
            document.querySelector("#glow").setAttribute('src', document.querySelector("#glow").getAttribute('src').replace('_off', '_on'))
            enableGlow = 1;
        }

        })
        document.addEventListener('click', function (e) {
          let el = e.target.closest('.iconButton');
          if (!el) return;
          for (let el of document.querySelectorAll(".iconButton")) el.classList.remove("iconSelected");
          el.classList.add('iconSelected');
          selectedIcon = el.getAttribute('num');
          selectedForm = el.getAttribute('form');
          if (selectedIcon == 143) selectedIcon = 0;
        })
    })
document.getElementById("downloadIcon").onmousedown = function(event) {
    if (event.button == 2) {
        alert("URL copied to clipboard!");
        var temp = document.createElement("<div>"),
          sel = window.getSelection(),
          r = document.createRange();
        temp.textContent = 'https://gdbrowser.com' + document.querySelector('#result').getAttribute('src').slice(2)
        document.body.append(temp);
        r.selectNodeContents(temp);
        sel.removeAllRanges();
        sel.addRange(r);
        document.execCommand("copy");
        temp.parentNode.removeChild(temp);
    }
}

function backButton() {
	if (window.history.length > 1 && document.referrer.startsWith(window.location.origin)) window.history.back()
	window.location.href = "../../../../../"
}

document.addEventListener('keydown', function(k) {
	if (k.code == 'Escape') { //esc
		k.preventDefault()
		document.querySelector('#backButton').click()
	}
}, {passive: true});
</script>